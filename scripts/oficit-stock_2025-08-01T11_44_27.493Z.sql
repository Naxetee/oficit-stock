DROP TABLE IF EXISTS "Composicion_Prod.Compuesto" CASCADE;
DROP TABLE IF EXISTS "Composicion_Pack" CASCADE;
DROP TABLE IF EXISTS "Producto_Compuesto" CASCADE;
DROP TABLE IF EXISTS "Producto_Simple" CASCADE;
DROP TABLE IF EXISTS "Producto" CASCADE;
DROP TABLE IF EXISTS "Pack" CASCADE;
DROP TABLE IF EXISTS "Articulo" CASCADE;
DROP TABLE IF EXISTS "Componente" CASCADE;
DROP TABLE IF EXISTS "Proveedor" CASCADE;
DROP TABLE IF EXISTS "Color" CASCADE;
DROP TABLE IF EXISTS "Familia" CASCADE;

-- Reset sequences for tables with GENERATED BY DEFAULT AS IDENTITY
ALTER SEQUENCE IF EXISTS "Componente_id_seq" RESTART WITH 1;
ALTER SEQUENCE IF EXISTS "Proveedor_id_seq" RESTART WITH 1;
ALTER SEQUENCE IF EXISTS "Color_id_seq" RESTART WITH 1;
ALTER SEQUENCE IF EXISTS "Familia_id_seq" RESTART WITH 1;
ALTER SEQUENCE IF EXISTS "Articulo_id_seq" RESTART WITH 1;
ALTER SEQUENCE IF EXISTS "Pack_id_seq" RESTART WITH 1;
ALTER SEQUENCE IF EXISTS "Composicion_Pack_id_pack_seq" RESTART WITH 1;

CREATE TABLE "Componente" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"nombre" VARCHAR(255) NOT NULL UNIQUE,
	"descripcion" TEXT,
	"id_proveedor" INTEGER,
	"id_color" INTEGER,
	"created_at" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	"updated_at" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	PRIMARY KEY("id")
);

CREATE TABLE "Proveedor" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"nombre" VARCHAR(127) NOT NULL UNIQUE,
	"telefono" VARCHAR(31),
	"email" VARCHAR(127),
	"direccion" VARCHAR(255),
	"activo" BOOLEAN DEFAULT False,
	"created_at" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	"updated_at" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	PRIMARY KEY("id")
);

CREATE TABLE "Color" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"nombre" VARCHAR(31) NOT NULL UNIQUE,
	"hex" VARCHAR(7),
	"url_imagen" VARCHAR(511),
	"id_familia" INTEGER,
	"created_at" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	"updated_at" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	PRIMARY KEY("id")
);

CREATE TABLE "Familia" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"nombre" VARCHAR(127) NOT NULL UNIQUE,
	"descripcion" TEXT,
	"created_at" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	"updated_at" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	PRIMARY KEY("id")
);

CREATE TABLE "Articulo" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"nombre" VARCHAR(255),
	"descripcion" TEXT,
	"codigo_tienda" VARCHAR(31) UNIQUE,
	"id_familia" INTEGER,
	"activo" BOOLEAN DEFAULT False,
	"tipo" VARCHAR(255) NOT NULL CHECK(tipo IS NULL OR tipo IN ('simple', 'compuesto', 'pack')),
	"created_at" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	"updated_at" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	PRIMARY KEY("id")
);

CREATE TABLE "Producto" (
	"id" INTEGER NOT NULL UNIQUE,
	PRIMARY KEY("id")
) INHERITS ("Articulo");

CREATE TABLE "Producto_Simple" (
	"id_proveedor" INTEGER,
	"id_color" INTEGER,
	PRIMARY KEY("id")
) INHERITS ("Producto");

CREATE TABLE "Producto_Compuesto" (
	"id" INTEGER NOT NULL UNIQUE,
	PRIMARY KEY("id")
) INHERITS ("Producto");

CREATE TABLE "Composicion_Prod.Compuesto" (
	"id_producto_compuesto" INTEGER,
	"id_componente" INTEGER,
	"cantidad" INTEGER,
	PRIMARY KEY("id_producto_compuesto", "id_componente")
);

CREATE TABLE "Pack" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	PRIMARY KEY("id")
) INHERITS ("Articulo");

CREATE TABLE "Composicion_Pack" (
	"id_pack" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"id_producto" INTEGER NOT NULL,
	"cantidad" INTEGER NOT NULL DEFAULT 0,
	PRIMARY KEY("id_pack", "id_producto")
);


ALTER TABLE "Componente"
ADD FOREIGN KEY("id_proveedor") REFERENCES "Proveedor"("id")
ON UPDATE CASCADE ON DELETE RESTRICT;
ALTER TABLE "Componente"
ADD FOREIGN KEY("id_color") REFERENCES "Color"("id")
ON UPDATE CASCADE ON DELETE RESTRICT;
ALTER TABLE "Color"
ADD FOREIGN KEY("id_familia") REFERENCES "Familia"("id")
ON UPDATE CASCADE ON DELETE RESTRICT;
ALTER TABLE "Articulo"
ADD FOREIGN KEY("id_familia") REFERENCES "Familia"("id")
ON UPDATE CASCADE ON DELETE RESTRICT;
ALTER TABLE "Producto_Simple"
ADD FOREIGN KEY("id_proveedor") REFERENCES "Proveedor"("id")
ON UPDATE CASCADE ON DELETE RESTRICT;
ALTER TABLE "Producto_Simple"
ADD FOREIGN KEY("id_color") REFERENCES "Color"("id")
ON UPDATE CASCADE ON DELETE RESTRICT;
ALTER TABLE "Composicion_Prod.Compuesto"
ADD FOREIGN KEY("id_producto_compuesto") REFERENCES "Producto_Compuesto"("id")
ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE "Composicion_Prod.Compuesto"
ADD FOREIGN KEY("id_componente") REFERENCES "Componente"("id")
ON UPDATE CASCADE ON DELETE RESTRICT;
ALTER TABLE "Composicion_Pack"
ADD FOREIGN KEY("id_pack") REFERENCES "Pack"("id")
ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE "Composicion_Pack"
ADD FOREIGN KEY("id_producto") REFERENCES "Producto"("id")
ON UPDATE CASCADE ON DELETE RESTRICT;








